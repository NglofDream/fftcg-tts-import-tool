<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Manipulation</title>
</head>
<body>
    <h1>JSON File Processor</h1>
    <p>Process JSON files from your GitHub project.</p>
    <button id="processFiles">Process Files</button>
    <a id="downloadLink" style="display:none;">Download Processed JSON</a>

    <script>
const fs = require('fs');

function createJsonFile(data, filename) {
    fs.writeFileSync(filename, JSON.stringify(data, null, 4));
}

function readJsonFile(filename) {
    const data = fs.readFileSync(filename, 'utf8');
    return JSON.parse(data);
}

// Existing JSON file names
const existingFilename = "data.json";
const templateFilename = "template.json";
const ttsdeckFilename = "ttsdeck.json";

// Read data from JSON files
const existingData = readJsonFile(existingFilename);
const templateData = readJsonFile(templateFilename);
const ttsdeckData = readJsonFile(ttsdeckFilename);

// Extract data from existing JSON structure
const dataList = existingData.cards || [];

// Extract data from template JSON structure
const templateList = templateData.ObjectStates || [];

// Custom sorting key function
function customKey(card) {
    let serialNumber = card.serial_number;
    if (serialNumber.startsWith("PR-")) {
        serialNumber = "99" + serialNumber.slice(2); // Change "PR-" to "99-"
    }

    if (serialNumber.includes('-')) {
        const [prefix, number] = serialNumber.split('-');
        return [parseInt(prefix), parseInt(number)];
    } else {
        return [Infinity, parseInt(serialNumber)]; // In case there's no prefix, put it at the end
    }
}

// Sort the cards based on the serial numbers using the custom key function
const sortedCards = existingData.cards.sort((a, b) => {
    const [aPrefix, aNumber] = customKey(a);
    const [bPrefix, bNumber] = customKey(b);
    return (aPrefix - bPrefix) || (aNumber - bNumber);
});

// Update the original data with the sorted cards
existingData.cards = sortedCards;

// Convert the sorted data back to JSON format
const sortedJson = JSON.stringify(existingData, null, 4);

const startUrl = "https://storage.googleapis.com/ffdecks-card-images/";
const endUrl = "_eg.jpg";
let rarity = "";
const newDataList = [];

dataList.forEach(item => {
    rarity = item.rarity === "Promo" ? "" : item.rarity;

    const newItem = {
        Nickname: item.name,
        FaceURL: `${startUrl}${item.serial_number}${rarity.charAt(0)}${endUrl}`,
        Description: item.abilities ? item.abilities.join(", ") : ""
    };

    newDataList.push(newItem);
});

// Create new JSON files based on templateData with replaced data
const deck = [];
const deckIds = [];
const tempData = [];
const ids = 554;

newDataList.forEach((item, i) => {
    const temporaryDeckcode = {
        FaceURL: item.FaceURL,
        BackURL: "http://cloud-3.steamusercontent.com/ugc/948455238665576576/85063172B8C340602E8D6C783A457122F53F7843/",
        NumWidth: 1,
        NumHeight: 1,
        BackIsHidden: "true",
        UniqueBack: "false",
        Type: 0
    };

    tempData.push(temporaryDeckcode);

    const temporaryCardcode = {
        Name: "CardCustom",
        Transform: {
            posX: 42.494194,
            posY: 0.989706635,
            posZ: 10.5498743,
            rotX: 359.7435,
            rotY: 179.999451,
            rotZ: -0.00222716271,
            scaleX: 2.17791772,
            scaleY: 1.0,
            scaleZ: 2.17791772
        },
        Nickname: item.Nickname,
        Description: item.Description,
        GMNotes: "",
        AltLookAngle: { x: 0, y: 0, z: 0 },
        ColorDiffuse: { r: 0.713235259, g: 0.713235259, b: 0.713235259 },
        LayoutGroupSortIndex: 0,
        Value: 0,
        Locked: "false",
        Grid: "true",
        Snap: "true",
        IgnoreFoW: "false",
        MeasureMovement: "false",
        DragSelectable: "true",
        Autoraise: "true",
        Sticky: "true",
        Tooltip: "true",
        GridProjection: "false",
        HideWhenFaceDown: "true",
        Hands: "true",
        CardID: (ids + i) * 100,
        SidewaysCard: "false",
        CustomDeck: {
            [ids + i]: temporaryDeckcode
        },
        LuaScript: "",
        LuaScriptState: "",
        XmlUI: ""
    };

    deckIds.push((ids + i) * 100);
    deck.push(temporaryCardcode);
});

ttsdeckData.ObjectStates[0].CustomDeck = Object.assign({}, ...tempData.map((item, index) => ({ [ids + index]: item })));
ttsdeckData.ObjectStates[0].DeckIDs = deckIds;
ttsdeckData.ObjectStates[0].ContainedObjects = deck;

createJsonFile(ttsdeckData, "deck.json");

    </script>
</body>
</html>
